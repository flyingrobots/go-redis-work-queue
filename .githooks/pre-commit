#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

if [ -f scripts/update_progress.py ]; then
  echo "[pre-commit] Recomputing weighted progress and updating bars…"
  python_cmd=""
  if command -v python3 >/dev/null 2>&1; then
    python_cmd="python3"
  elif command -v python >/dev/null 2>&1; then
    python_cmd="python"
  else
    echo "[pre-commit] No Python interpreter (python3/python) found in PATH." >&2
    exit 1
  fi

  if ! "$python_cmd" scripts/update_progress.py; then
    echo "[pre-commit] Progress update failed. Aborting commit." >&2
    exit 1
  fi
  # Stage updated docs so the commit includes refreshed bars/KLoC
  git add docs/features-ledger.md README.md || true
fi

# Ensure HTTP handlers keep emitting X-Request-ID via requestidlint
if command -v go >/dev/null 2>&1; then
  echo "[pre-commit] Running request ID lint…"
  if ! go run ./tools/requestidlint/cmd/requestidlint ./internal/admin-api; then
    echo "[pre-commit] requestidlint failed. Aborting commit." >&2
    exit 1
  fi
else
  echo "[pre-commit] Go toolchain not found; skipping requestidlint." >&2
  exit 1
fi

exit 0
