---
title: e35da518e543d331abf0b57fa939d682d39f5a88.md (chunk 010)
description: Preserved review artifacts and rationale.
audience: [contributors]
domain: [quality]
tags: [review]
status: archive
---

# Code Review Feedback

<!-- chunk-progress:begin -->
```text
░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 0.0% (0/30 addressed)
```
<!-- chunk-progress:end -->

| Date | Agent | SHA | Branch | PR |
|------|-------|-----|--------|----|
| 2025-09-16 | CodeRabbit | `e35da518e543d331abf0b57fa939d682d39f5a88` | [unify/chaos-main](https://github.com/flyingrobots/go-redis-work-queue/tree/unify/chaos-main "flyingrobots/go-redis-work-queue:unify/chaos-main") | [PR#3](https://github.com/flyingrobots/go-redis-work-queue/pull/3) |

## Instructions

Please carefully consider each of the following feedback items, collected from a GitHub code review.

Please act on each item by fixing the issue, or rejecting the feedback. Please update this document and fill out the information below each feedback item by replacing the text surrounded by curly braces.

### deployments/docker/Dockerfile.rbac-token-service:27

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/docker/Dockerfile.rbac-token-service around lines 25-27 (and also
update the similar install at lines 53-54), the image currently installs
ca-certificates, tzdata and wget but the project standard prefers curl for
healthchecks; update the RUN apk --no-cache add ... commands to include curl so
curl is available at runtime for healthcheck scripts and make the same change
for the duplicate install at lines 53-54.
```

{response}

### docs/00_assessment.md:3

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/00_assessment.md around line 3, the "Last updated: 2025-09-12" header is
stale for this 2025-09-16 PR; update the timestamp to the current PR date (e.g.,
"Last updated: 2025-09-16") or remove the line entirely if you prefer not to
track last-updated metadata.
```

{response}

### docs/02_release_plan.md:7

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/02_release_plan.md around lines 6–7, the release plan text needs
explicit freeze windows, rollout/rollback and go/no‑go gates: add a 48–72h code
freeze before each milestone date (2025-09-26, 2025-10-10, 2025-10-24,
2025-11-07), list the required sign‑off owners for each gate and a short
rollback plan for each release, and add “no High/Critical CVEs” plus
“govulncheck clean” as hard pre‑release gates; update the milestone entries to
include these freeze window dates, the sign‑off owner field, and a one‑line
rollback procedure for each.
```

{response}

### docs/10_risk_register.md:3

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/10_risk_register.md around line 3, the "Last updated" timestamp is stale
(2025-09-12); update that line to "Last updated: 2025-09-16" and save the file,
and ensure the updated commit includes this change (or implement a quick check
to update the date when editing this file in future).
```

{response}

### docs/api/admin-api.md:359

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/api/admin-api.md around lines 356 to 359, the docs mention a “minimum
reason length” but do not define it; update the text to state the exact minimum
(e.g., "Minimum reason length: 10 characters") and the validation behavior: if
the reason is missing or shorter than the minimum the API responds with HTTP 400
and an error body containing code "REASON_REQUIRED" (include a brief example
response schema or one-line note showing HTTP 400 + code REASON_REQUIRED).
Ensure the wording is precise and replaces the vague phrase with the concrete
minimum and the stated HTTP error/code behavior.
```

{response}

### docs/api/anomaly-radar-slo-budget.md:80

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/api/anomaly-radar-slo-budget.md around lines 76 to 80, the repo has
mixed go-redis client versions (github.com/go-redis/redis/v8 vs
github.com/redis/go-redis/v9); choose one version (preferably migrate all to v9
or standardize on v8), update all import paths listed in the comment to the
chosen module, update go.mod accordingly, run go mod tidy, run the full test
suite, and fix any API incompatibilities caused by the version change before
merging.
```

{response}

### docs/api/canary-deployments.md:11

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/api/canary-deployments.md around lines 7 to 11 (and also apply the same
change to lines 753-760), the README currently shows insecure HTTP URLs by
default; change the examples to use HTTPS (and WSS for WebSocket examples) as
the default secure scheme, and move any http/ws examples into a clearly labeled
"Local development" note that indicates using http://localhost only for local
testing; update the Base URL block to use https://... and add a short local-dev
snippet showing the http://localhost URL with an explicit note.
```

{response}

### docs/api/dlq-remediation-pipeline.md:858

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/api/dlq-remediation-pipeline.md around lines 761 to 858, the notify
action examples and description omit operational safeguards for outbound egress;
update the docs to define an explicit outbound allowlist for notification
destinations, default and configurable network timeouts, retry policy (attempt
count, backoff), a notification DLQ/escape hatch for failed deliveries, and
clear semantics for partial failures (e.g., per-channel success/failure
reporting, rollback/no-rollback behavior, and how the pipeline marks the job).
Also include recommended defaults and configuration keys, and an example showing
how to configure allowlist, timeouts, retries, and DLQ behavior.
```

{response}

### docs/api/exactly-once-admin.md:33

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/api/exactly-once-admin.md around lines 25-33 (and also apply the same
change to lines 56-61), the deduplication field "hit_rate" is ambiguous; rename
the field to "hit_percent" and update its value semantics to be a percentage
(e.g., 2.28 means 2.28%), then update the dedup stats JSON example accordingly
and edit the "Fields" documentation block to reflect the new name and explicitly
state that hit_percent is a percentage value (not a fraction) with its units.
```

{response}

### docs/SLAPS/coordinator-observations.md:116

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/SLAPS/coordinator-observations.md around lines 114-116 (and also apply
the same fix at 235-242), the text shows “19 tasks completed successfully” while
elsewhere it shows “74 completed,” causing confusion; update the copy to
explicitly annotate that “19” refers to an early snapshot or intermediate
checkpoint and “74” is the final total (or reconcile to a single consistent
number), e.g., add a parenthetical or an extra sentence clarifying the
timeline/source of each number so readers understand they are different
snapshots rather than inconsistent data.
```

{response}

### docs/SLAPS/coordinator-observations.md:130

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/SLAPS/coordinator-observations.md around lines 121 to 130, the
timestamps are missing timezone/offset information; update every timestamp to a
full ISO‑8601 format including date and timezone offset (e.g.
2025-09-16T12:10:00-07:00 or use Z for UTC) so Start Time, End Time and any
other time entries explicitly include timezone/offset; keep human-friendly
labels but ensure machine-parseable ISO strings are used consistently throughout
the file.
```

{response}

### docs/SLAPS/coordinator-observations.md:251

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
docs/SLAPS/coordinator-observations.md around lines 249-251: the document
contains a profane user quote ("fuck lol thats amazing") which is inappropriate
for a public repo; remove or sanitize the phrase by either replacing it with a
neutral placeholder quote (e.g., "User: 'That's amazing'") or redact the
offending word (e.g., "User: '[redacted] lol that's amazing'"), and ensure the
surrounding sentence still reads naturally and retains the original intent.
```

{response}

### docs/YOU ARE WORKER 6.rb:5

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/YOU ARE WORKER 6.rb around lines 1 to 5, the file contains non-Ruby
documentation which breaks RuboCop; either rename the file to a documentation
extension (e.g., docs/YOU ARE WORKER 6.md) or keep the .rb extension but wrap
the entire content in Ruby-safe comment or code fences (e.g., block comments or
a heredoc) so RuboCop ignores it; pick one approach, update the filename or wrap
the content accordingly, and adjust any references in the repo to the new path
if renamed.
```

{response}

### EVENT_HOOKS_TEST_DOCUMENTATION.md:320

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In EVENT_HOOKS_TEST_DOCUMENTATION.md around lines 314 to 320, the examples use
file globs and improper flag placement; replace them with package-wide
invocations and a proper -run regex: use go test -v ./... -args -debug to enable
verbose logging with the debug arg, and use go test -v ./... -run
'^TestSpecificTest$' to run a single test (anchored regex) so tests target
packages correctly and flags are applied as intended.
```

{response}

### AGENTS.md:41

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In AGENTS.md around lines 10 to 41, the table of contents uses Obsidian-style
wiki links ([[...]]), which won’t render correctly in standard Markdown; convert
each wiki link to a standard Markdown anchor link using the format
[Text](#anchor) where the anchor is the lowercased, hyphenated heading text
(remove extra hashes and punctuation), and update nested entries accordingly so
all TOC links point to the correct section IDs.
```

{response}

### deployments/admin-api/k8s-deployment.yaml:116

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/admin-api/k8s-deployment.yaml around lines 62 to 116, the
container/pod lacks basic security hardening; add a pod-level and
container-level securityContext to prevent privilege escalation and enforce
least privilege: set spec.template.spec.automountServiceAccountToken: false,
podSecurityContext.runAsNonRoot: true and runAsUser (e.g., 1000) and fsGroup if
needed; in the container securityContext set allowPrivilegeEscalation: false,
readOnlyRootFilesystem: true, runAsNonRoot: true (or match pod runAsUser), and
drop Linux capabilities (capabilities.drop: ["ALL"]); also enable seccomp by
setting securityContext.seccompProfile.type: RuntimeDefault (or annotation for
older k8s) to enforce a default seccomp profile. Ensure values are consistent
between pod and container contexts and do not conflict with existing volume
mounts.
```

{response}

### deployments/admin-api/k8s-deployment.yaml:159

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/admin-api/k8s-deployment.yaml around lines 117 to 159, the
ingress is fine but you must ensure the Deployment's container probe paths
differ: update the Deployment spec (the container's probes) so
readinessProbe.path is /ready or /readyz and the livenessProbe stays on a
different path (e.g., /health or /live); apply this change in the Deployment
manifest (set readinessProbe.path to /ready or /readyz, keep livenessProbe on
the existing health endpoint) so the readiness check does not use the same
endpoint as liveness.
```

{response}

### deployments/docker/docker-compose.yaml:109

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/docker/docker-compose.yaml around lines 105 to 109 the compose
mounts refer to ./grafana/dashboards and ./grafana/datasources but the
repository stores these under deploy/grafana; update the volume paths to point
to ../../deploy/grafana/dashboards and ../../deploy/grafana/datasources (or
alternatively create the missing local ./grafana/datasources directory and add
the required datasource files), ensuring the compose file uses the correct
relative paths to the existing deploy/grafana directories.
```

{response}

### deployments/docker/rbac-configs/resources.yaml:104

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/docker/rbac-configs/resources.yaml around lines 91-104 (and also
check 146-167 and 167-204), the actions catalog is missing the referenced
monitoring/health actions and contains an undefined queues:list alias; add
explicit action entries for "metrics:read" and "health:read" (with description,
risk_level and audit_required) and either add a clear explicit "queues:list"
action entry if you want it aliased to an existing queue read/list permission or
remove any references to queues:list from roles; ensure all roles reference only
actions that are declared in this file.
```

{response}

### deployments/docker/rbac-configs/token-service.yaml:24

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/docker/rbac-configs/token-service.yaml around lines 21 to 24, the
JWT config uses a symmetric HS256 key which is unsafe across multiple services;
replace it with an asymmetric algorithm (e.g., RS256 or EdDSA) or PASETO
v4.public, generate a signing private key and a separate public verification key
(use RSA 3072/4096 or Ed25519 as chosen), store the private key only in the
token-service secret and distribute the public key to all verifier services (or
publish via a JWKS endpoint), update the config to reflect algorithm and
key_size appropriate for the chosen algorithm, and add/update deployment docs to
describe the key rotation process (generate new keypair, deploy new public key
to verifiers, switch signer to new private key, and revoke old keys) so
sign/verify roles remain separated.
```

{response}

### deployments/kubernetes/admin-api-deployment.yaml:100

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/kubernetes/admin-api-deployment.yaml around lines 90 to 100, the
pod-level securityContext exists but the container is missing baseline
hardening; add a container-level securityContext that sets
allowPrivilegeEscalation: false, privileged: false, drops all capabilities
(capabilities.drop: ["ALL"]), sets readOnlyRootFilesystem: true, and configures
a seccompProfile (type: RuntimeDefault) so the container cannot escalate
privileges, has no extra capabilities, uses a read-only root filesystem and
enforces seccomp; keep existing pod runAsNonRoot/runAsUser/fsGroup settings
intact.
```

{response}

### deployments/kubernetes/monitoring.yaml:38

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/kubernetes/monitoring.yaml around lines 35 to 38, the alert
divides by sum(rate(http_requests_total{app="admin-api"}[5m])) which can be
zero; change the PromQL to guard the denominator (for example wrap the
denominator with clamp_min(..., 1) or otherwise ensure it’s >0 before dividing)
so the expression never performs a division by zero and the rule won’t flap when
traffic is 0.
```

{response}

### deployments/kubernetes/rbac-monitoring.yaml:54

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/kubernetes/rbac-monitoring.yaml around lines 45–54, the expr
currently uses raw 5xx RPS instead of a ratio; replace it with a ratio of 5xx
requests to total requests over the same window (and aggregate across labels) —
for example use
sum(rate(http_requests_total{job="rbac-token-service",status=~"5.."}[5m])) /
sum(rate(http_requests_total{job="rbac-token-service"}[5m])) > 0.1 — keeping the
same for/labels/annotations.
```

{response}

### deployments/kubernetes/rbac-monitoring.yaml:75

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/kubernetes/rbac-monitoring.yaml around lines 56 to 75, the
histogram_quantile calls are using raw bucket series instead of aggregated
buckets; replace the inner range vector with sum by (le) over the bucket
streams, e.g. histogram_quantile(0.95, sum by (le)
(rate(http_request_duration_seconds_bucket{job="rbac-token-service"}[5m]))), and
apply the same change for the second alert (the >1.0 and >5.0 thresholds remain
unchanged); ensure both alerts use the sum by (le) aggregation for correct
quantile calculation.
```

{response}

### deployments/kubernetes/rbac-token-service-deployment.yaml:205

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/kubernetes/rbac-token-service-deployment.yaml around lines
197–205 (and container block around lines ~231–238) the pod and container
security settings are insufficient: add under pod spec securityContext the
seccompProfile with type: RuntimeDefault and set automountServiceAccountToken:
false; in the rbac-token-service container add a container-level securityContext
with allowPrivilegeEscalation: false, readOnlyRootFilesystem: true, and
capabilities.drop: ["ALL"]; replace the image:
work-queue/rbac-token-service:latest with a pinned immutable image tag (e.g.,
:vX.Y.Z) and change imagePullPolicy to IfNotPresent for pinned images; after
updating, run Checkov/OPA Gatekeeper to verify CKV_K8S_* findings are resolved.
```

{response}

### deployments/kubernetes/rbac-token-service-deployment.yaml:229

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/kubernetes/rbac-token-service-deployment.yaml around lines
209-229 (and also apply the same change to blocks at 255-262 and 263-271), stop
injecting sensitive secret values (redis-password, rbac-signing-key,
rbac-encryption-key) directly as env values; instead mount the existing Secret
as a volume and update the container spec to volumeMount those secret files,
then change the app to read the secret files from the mounted paths (or if the
app requires env paths, set non-sensitive env vars to the file paths only).
Remove the valueFrom secretKeyRef entries for the secret keys, add a volumes:
entry referencing the Secret name rbac-secrets, add corresponding volumeMounts
with a secure mountPath, and ensure RBAC_SIGNING_KEY, RBAC_ENCRYPTION_KEY and
REDIS_PASSWORD are no longer exposed directly in logs/environment but accessed
from the mounted files; repeat the same adjustments for the other noted blocks.
```

{response}

### deployments/scripts/deploy-staging.sh:166

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/scripts/deploy-staging.sh around lines 161-166 (and also apply
same change to 203-204), the script uses unquoted PID variables and lacks a
cleanup trap; update to quote the PID variables and guard against empty values
(e.g. check [ -n "$PF_PID" ] before calling kill) to avoid globbing/empty-var
issues, and add a trap (e.g. trap cleanup EXIT) plus a small cleanup function
that safely kills quoted PIDs (using kill "$PF_PID" 2>/dev/null || true) to
ensure processes are terminated on exit.
```

{response}

### deployments/scripts/health-check-rbac.sh:191

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/scripts/health-check-rbac.sh around lines 173 to 191, replace the
blind sleep used to wait for the port-forward with an active poll that verifies
the local port is accepting TCP connections: implement a loop that checks
localhost:8081 (using a portable method such as bash /dev/tcp/localhost/8081 or
nc if available) with the same $TIMEOUT, exiting success as soon as a connection
can be opened and logging a timeout error if the port never becomes ready; keep
the subsequent HTTP health/metrics checks unchanged and ensure the overall wait
honours the $TIMEOUT variable.
```

{response}

### deployments/scripts/setup-monitoring.sh:226

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In deployments/scripts/setup-monitoring.sh around lines 225-226, the kill call
uses an unquoted variable which can break if the PID contains spaces or is
empty; change it to quote the variable (use kill "$port_forward_pid" 2>/dev/null
|| true) so the PID is passed safely and to avoid word-splitting or globbing.
```

{response}

### docs/api/dlq-remediation-pipeline.md:171

- [ ] Fixed
- [ ] Test Written
- [ ] Suggestion Ignored

```text
In docs/api/dlq-remediation-pipeline.md around lines 149-171, the example
response uses a string duration and lacks a clear dry-run and idempotency
contract; change the response to expose duration_ms as an integer (milliseconds)
instead of a string "125ms", explicitly state dry_run is a boolean that
guarantees no state changes when true, and update the POST
/pipeline/process-batch docs to add an Idempotency-Key header (string, optional
but required for at‑least‑once safe retries) and a semantics note that requests
with the same Idempotency-Key must return the original 200 response with an
identical body for 24 hours to prevent duplicate execution.
```

{response}
